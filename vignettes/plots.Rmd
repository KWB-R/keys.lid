---
title: "Plots"
author: "Michael Rustler"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```



## VRR without LIDs

```{r reference, echo=TRUE, fig.height = 5, fig.width=7}
library(keys.lid)
performances <- keys.lid::performances %>%
  dplyr::mutate(
scenario_name = kwb.utils::multiSubstitute(strings = .data$scenario_name,
                                           replacements = list("through-trench" = "mulde_rigole",
                                                               "through" = "mulde",
                                                               "with-berm" = "mit-berme",
                                                               "no-berm" = "ohne-berme",
                                                               "no-drainmat" = "keine-drainagematte",
                                                               "with-drainmat" = "mit-drainagematte",
                                                               "no-drainage" = "keine-drainage",
                                                               "with-drainage" = "mit-drainage",
                                                               "per.hour" = "pro.Stunde",
                                                               "extensive" = "extensiv",
                                                               "intensive" = "intensiv"))
) %>%
                  dplyr::group_by(.data$lid_name_tidy,
                                  .data$scenario_name) %>%
                  dplyr::mutate(scenario_id = dplyr::cur_group_id())

performances_without_lids <- performances %>%
  dplyr::filter(.data$lid_name_tidy == "bioretention_cell",
                .data$lid_area_fraction == 0,
                .data$scenario_id == 1) %>%
  dplyr::mutate(lid_name_tidy = "Referenz",
                scenario_name = "Regenr\u00FCckhalt ohne LID")


mycolors <- c(rev(RColorBrewer::brewer.pal(name="Reds", n = 6)),
              RColorBrewer::brewer.pal(name="Blues", n = 6))

performances_without_lids %>%
  tidyr::unnest(.data$annual) %>%
  ggplot2::ggplot(mapping = ggplot2::aes(x = .data$zone_id,
                                         y = 100*.data$vrr)) +
  ggplot2::scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  ggplot2::geom_boxplot() +
  ggplot2::geom_jitter(mapping = ggplot2::aes(col = factor(.data$year)),
                       size=2, alpha=0.8) +
  ggplot2::scale_color_manual(values = mycolors) +
  ggplot2::stat_summary(ggplot2::aes(label=sprintf("%d %%", round(..y..,0))), 
                        fun.y = median, 
                        geom="text", 
                        size = 3,
                        fontface = "bold",
                        vjust = -0.5,
                        ) +
  ggplot2::labs(title = "Modelleinzugsgebiet (100% Versiegelungsgrad)",
                x = "Klimazone",
                y = "J\u00E4hrlicher Regenr\u00FCckhalt ohne LIDs",
                col = "Jahr") +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.position="top")

ggplot2::ggsave("vrr_reference.jpg",
                scale = 1, 
                width = 7, 
                height = 5)

```

## VRR with LIDs

```{r lid_performance, echo=TRUE, fig.height = 5, fig.width=7}

performances_without_lids <- performances %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(.data$lid_area_fraction == 0) %>% 
  tidyr::unnest(.data$annual) %>% 
  dplyr::rename(vrr_reference = .data$vrr) %>% 
  dplyr::select(.data$zone_id, 
                .data$lid_name_tidy, 
                .data$scenario_id,
                .data$year,
                .data$vrr_reference
                )

percent_lid_area <- 100
  
performances_lid <- performances %>%  
  dplyr::filter(.data$lid_name_tidy == "bioretention_cell" & .data$lid_area_fraction == percent_lid_area/100 |
                .data$lid_name_tidy == "permeable_pavement" & .data$lid_area_fraction == percent_lid_area/100 |
                .data$lid_name_tidy == "green_roof" & .data$lid_area_fraction == percent_lid_area/100) %>%  
  tidyr::unnest(.data$annual) %>% 
  dplyr::left_join(performances_without_lids) %>% 
  dplyr::mutate(lid_name_tidy = kwb.utils::multiSubstitute(strings = .data$lid_name_tidy,
                                                           replacements = list(
                                                           "bioretention_cell" = "Versickerungsmulden",
                                                           "green_roof" = "Gr\u00FCnd\u00E4cher",
                                                           "permeable_pavement" = "Durchl\u00E4ssige Bodenbel\u00E4ge")
                                                           ))


plot_lid_performance <- function(lid_name, scenario_ids = NULL) {
  
  if(is.null(scenario_ids)) {
    scenario_ids <- performances_lid %>% 
      dplyr::filter(.data$lid_name_tidy == lid_name) %>% 
      dplyr::pull(.data$scenario_id) %>% 
      unique()
  }
  
  lid_area_faction <- performances_lid %>% 
      dplyr::filter(.data$lid_name_tidy == lid_name) %>% 
      dplyr::pull(lid_area_fraction) %>% 
      unique()*100 
    
  
performances_lid %>% 
  dplyr::filter(.data$lid_name_tidy == lid_name,
                .data$scenario_id %in% scenario_ids) %>% 
  dplyr::mutate(label = sprintf("%s: %s", 
                                .data$lid_name_tidy, 
                                .data$scenario_name)) %>% 
  ggplot2::ggplot(mapping = ggplot2::aes(x = .data$zone_id,
                                         y = 100*.data$vrr)) +
  ggplot2::facet_wrap(~ .data$scenario_name, ncol = 1) +
  ggplot2::scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  ggplot2::geom_boxplot() +
  ggplot2::geom_jitter(mapping = ggplot2::aes(col = factor(.data$year)),
                       size=2, alpha=0.8) +
  ggplot2::scale_color_manual(values = mycolors) +
  ggplot2::stat_summary(ggplot2::aes(label=sprintf("%d %%", round(..y..,0))), 
                        fun.y = median, 
                        geom="text", 
                        size = 3,
                        fontface = "bold",
                        vjust = -0.5,
                        ) +
  ggplot2::labs(title = sprintf("%s (%d %% der Einzugsgebietsfl\u00E4che)",
                                lid_name, 
                                lid_area_faction),
                x = "Klimazone",
                y = "J\u00E4hrlicher Regenr\u00FCckhalt mit LIDs",
                col = "Jahr") +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.position="top")
}

lid_names <- unique(performances_lid$lid_name_tidy)

bioretention_cells <- plot_lid_performance(lid_names[1],
                                           scenario_ids = c(1:3, 7))

ggplot2::ggsave(filename = sprintf("vrr_lid_versickerungsmulden_%d-prozent.jpg",
                                   percent_lid_area),
                plot = bioretention_cells,
                scale = 1, 
                width = 7, 
                height = 2.2*5,
                limitsize = FALSE)

green_roofs <- plot_lid_performance(lid_names[2],
                                    scenario_ids = 15:18)
ggplot2::ggsave(filename = sprintf("vrr_lid_gruendaecher_%d-prozent.jpg",
                                   percent_lid_area),
                plot = green_roofs,
                scale = 1, 
                width = 7, 
                height = 2.2*5,
                limitsize = FALSE)

permeable_pavements <- plot_lid_performance(lid_names[3],
                                    scenario_ids = 19:20)

ggplot2::ggsave(filename = sprintf("vrr_lid_durchlaessige-bodenbelaege_%d-prozent.jpg",
                                   percent_lid_area),
                plot = permeable_pavements,
                scale = 1, 
                width = 7, 
                height = 1.1*5,
                limitsize = FALSE)



```

